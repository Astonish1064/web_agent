{"code": "// localStorage-style polyfill for browser and Node.js\nconst localStorage = (function() {\n    let storage = {};\n    \n    if (typeof window !== 'undefined' && window.localStorage) {\n        // Browser environment\n        return window.localStorage;\n    } else {\n        // Node.js or other environment\n        return {\n            getItem: function(key) {\n                return storage[key] || null;\n            },\n            setItem: function(key, value) {\n                storage[key] = String(value);\n            },\n            removeItem: function(key) {\n                delete storage[key];\n            },\n            clear: function() {\n                storage = {};\n            }\n        };\n    }\n})();\n\nclass BusinessLogic {\n    constructor() {\n        this._initStorage();\n    }\n\n    _initStorage() {\n        const tables = ['users', 'products', 'orders', 'returns', 'shoppingCarts', 'policies', 'reviews'];\n        \n        tables.forEach(table => {\n            if (!localStorage.getItem(table)) {\n                localStorage.setItem(table, JSON.stringify([]));\n            }\n        });\n\n        // Initialize sample data if empty\n        if (this._getFromStorage('products').length === 0) {\n            this._initializeSampleData();\n        }\n    }\n\n    _initializeSampleData() {\n        const products = [\n            { id: 'p1', title: 'Foundation', author: 'Isaac Asimov', category: 'Science Fiction', price: 12.99, description: 'A masterpiece of science fiction', average_rating: 4.5 },\n            { id: 'p2', title: 'I, Robot', author: 'Isaac Asimov', category: 'Science Fiction', price: 10.99, description: 'Classic robot stories', average_rating: 4.3 },\n            { id: 'p3', title: 'The Murder on the Links', author: 'Agatha Christie', category: 'Mystery', price: 9.99, description: 'A Hercule Poirot mystery', average_rating: 4.7 },\n            { id: 'p4', title: 'And Then There Were None', author: 'Agatha Christie', category: 'Mystery', price: 11.99, description: 'Mystery thriller', average_rating: 4.8 }\n        ];\n\n        const policies = [\n            { id: 'policy1', title: 'Return Policy', category: 'Returns', content: 'Books can be returned within 30 days of delivery. Items must be in new condition with original packaging.' },\n            { id: 'policy2', title: 'Refund Policy', category: 'Refunds', content: 'Refunds will be processed within 5-7 business days after we receive the returned item.' }\n        ];\n\n        this._saveToStorage('products', products);\n        this._saveToStorage('policies', policies);\n    }\n\n    _getFromStorage(key) {\n        const data = localStorage.getItem(key);\n        return data ? JSON.parse(data) : [];\n    }\n\n    _saveToStorage(key, data) {\n        localStorage.setItem(key, JSON.stringify(data));\n    }\n\n    _generateId() {\n        return Date.now().toString(36) + Math.random().toString(36).substr(2);\n    }\n\n    // Task 1: Find return policy\n    getReturnPolicy() {\n        const policies = this._getFromStorage('policies');\n        return policies.find(policy => \n            policy.category === 'Returns' || \n            policy.title.toLowerCase().includes('return')\n        ) || null;\n    }\n\n    // Task 2: Create new account\n    createUser(email, password) {\n        const users = this._getFromStorage('users');\n        \n        if (users.some(user => user.email === email)) {\n            throw new Error('User already exists');\n        }\n\n        const newUser = {\n            id: this._generateId(),\n            email: email,\n            password_hash: btoa(password), // Simple encoding for demo\n            wishlist: [],\n            address_book: []\n        };\n\n        users.push(newUser);\n        this._saveToStorage('users', users);\n\n        // Create empty shopping cart\n        const shoppingCarts = this._getFromStorage('shoppingCarts');\n        shoppingC.push({\n            id: this._generateId(),\n            user_id: newUser.id,\n            items: []\n        });\n        this._saveToStorage('shoppingCarts', shoppingCarts);\n\n        return newUser.id;\n    }\n\n    // Task 3: Browse and add to wishlist\n    getProductsByCategoryAndAuthor(category, author) {\n        const products = this._getFromStorage('products');\n        return products.filter(product => \n            product.category === category && \n            product.author.toLowerCase().includes(author.toLowerCase())\n        );\n    }\n\n    addToWishlist(userId, productId) {\n        const users = this._getFromStorage('users');\n        const user = users.find(u => u.id === userId);\n        \n        if (!user) {\n            throw new Error('User not found');\n        }\n\n        const products = this._getFromStorage('products');\n        const product = products.find(p => p.id === productId);\n        \n        if (!product) {\n            throw new Error('Product not found');\n        }\n\n        const lineItem = {\n            id: this._generateId(),\n            product_id: productId,\n            quantity: 1\n        };\n\n        user.wish.push(lineItem);\n        this._saveToStorage('users', users);\n        \n        return lineItem.id;\n    }\n\n    // Task 4: Update password and add address\n    updatePassword(userId, newPassword) {\n        const users = this._getStorage('users');\n        const user = users.find(u => u.id === userId);\n        \n        if (!user) {\n            throw new Error('User not found');\n        }\n\n        user.password_hash = btoa(newPassword);\n        this._saveToStorage('users', users);\n    }\n\n    addShippingAddress(userId, addressData) {\n        const users = this._getFromStorage('users');\n        const user = users.find(u => u.id === userId);\n        \n        if (!user) {\n            throw new Error('User not found');\n        }\n\n        const newAddress = {\n            id: this._generateId(),\n            user_id: userId,\n            street: addressData.street,\n            city: addressData.city,\n            state: addressData.state,\n            zip_code: addressData.zip_code,\n            country: addressData.country\n        };\n\n        user.address_book.push(newAddress);\n        this._saveToStorage('users', users);\n        \n        return newAddress.id;\n    }\n\n    // Task 5: Browse highly-rated mystery books and add to cart\n    getHighlyRatedProducts(category, minRating = 4) {\n        const products = this._getFromStorage('products');\n        return products\n            .filter(product => \n                product.category === category && \n                product.average_ >= minRating\n            )\n            .sort((a, b) => b.average_rating - a.average_rating);\n    }\n\n    getProductReviews(productId) {\n        const reviews = this._getFromStorage('reviews');\n        return reviews.filter(review => review.product_id === productId);\n    }\n\n    addToCart(userId, productId, quantity = 1) {\n        const shoppingCarts = this._getFromStorage('hoppingCarts');\n        const cart = shoppingCarts.find(c => c.user_id === userId);\n        \n        if (!cart) {\n            throw new Error('Shopping cart not found');\n        }\n\n        const existingItem = cart.items.find(item => item.product_id === productId);\n        \n        if (existingItem) {\n            existingItem.quantity += quantity;\n        } else {\n            const newItem = {\n                id: this._generateId(),\n                product_id: productId,\n                quantity: quantity\n            };\n            cart.items.push(newItem);\n        }\n\n        this._saveToStorage('shoppingCarts', shoppingCarts);\n    }\n\n    // Task 6: Checkout process\n    checkout(userId, shippingAddressId, paymentInfo) {\n        const shoppingCarts = this._getFromStorage('shoppingCarts');\n        const cart = shopping